#!/bin/bash
set -e
# -*- coding: utf-8 -*-

echo "Running post-installation tasks for Lumen..."

APP_DIR="/usr/share/lumen"
VENV_DIR="$APP_DIR/venv"

# --- [1] Ensure dependencies ---
for pkg in python3 python3-venv python3-pip; do
    if ! dpkg -s "$pkg" >/dev/null 2>&1; then
        echo "[INFO] Installing missing dependency: $pkg"
        apt-get update -qq
        apt-get install -y "$pkg"
    fi
done

# --- [2] Create virtual environment ---
if [ ! -d "$VENV_DIR" ]; then
    echo "[INFO] Creating virtual environment in $VENV_DIR..."
    python3 -m venv "$VENV_DIR" || {
        echo "[ERROR] Failed to create virtual environment!"
        exit 1
    }
fi

# --- [3] Ensure pip inside venv ---
if [ ! -f "$VENV_DIR/bin/pip" ]; then
    echo "[INFO] Bootstrapping pip inside virtual environment..."
    "$VENV_DIR/bin/python" -m ensurepip --upgrade || true
fi

# --- [4] Use python -m pip safely ---
PIP_CMD="$VENV_DIR/bin/python -m pip"

echo "[INFO] Upgrading pip..."
$PIP_CMD install --upgrade pip --no-cache-dir

echo "[INFO] Installing PySide6..."
$PIP_CMD install PySide6 --no-cache-dir

# --- [5] Refresh desktop and icons ---
if [ -x /usr/bin/update-desktop-database ]; then
    echo "[INFO] Updating desktop database..."
    update-desktop-database /usr/share/applications
fi

if [ -x /usr/bin/gtk-update-icon-cache ]; then
    echo "[INFO] Updating GTK icon cache..."
    gtk-update-icon-cache /usr/share/icons/hicolor
fi

echo "[SUCCESS] Lumen installation completed successfully."

